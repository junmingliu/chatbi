# ChatBI工程规范（v0.1）

## 1. 编码规范（Coding Standard）

### 1.1 通用规范



* **可读性优先**：函数短小、命名清晰、避免 “魔法参数”

* **禁止跨层引用**：UI 不直接拼 SQL；Agent 不直连 DB（必须通过 Query Service）

* **所有外部依赖可替换**：LLM / 向量库 / 数据库连接必须有抽象层

### 1.2 前端规范（React + TS）



* TypeScript：`noImplicitAny`、`strict: true`

* 组件结构：


  * `components/`：纯展示组件（无数据请求）

  * `features/`：按业务域组织（chat、template、admin、audit）

  * `pages/`：路由页面

* 代码风格：ESLint + Prettier（强制）

* UI 组件原则：


  * 统一设计系统（颜色、间距、圆角、阴影）

  * 任何 “新样式” 必须沉淀为 token（见 UI 规范）

### 1.3 后端规范（FastAPI + Python 3.10）



* 风格：Ruff（lint）+ Black（format）+ isort（import）+ mypy（类型检查，建议逐步）

* 分层：


  * `routers/`（HTTP）→ `services/`（业务）→ `repositories/`（数据访问）

  * `schemas/`（Pydantic DTO）与 `models/`（ORM）分离

* 错误处理：统一 `ErrorCode` + `trace_id`，返回可定位错误与建议修复方案（文档也要求错误提示明确）

### 1.4 Agent 代码规范（LangGraph）



* 图节点（Node）必须满足：


  * 输入 / 输出都有类型定义（TypedDict / Pydantic）

  * 节点职责单一（例如：clarify /retrieve\_kb/generate\_sql /guardrail/execute /summarize/visualize）

* 工具（Tools）必须满足：


  * 明确的权限与参数校验（尤其 SQL 工具）

  * 可观测：记录耗时、命中率、错误类型

* Prompt 规范：


  * 系统策略与业务提示分离

  * 版本化（prompt 变更必须有 id + 变更说明 + 可回滚）



***

## 2. 测试规范（Testing Standard）

> 需求说明书明确：准确率 > 95%，数值误差≤±1%，并要求测试集覆盖四类场景且每类≥100 条；还要求澄清识别准确率≥98%。

### 2.1 测试分层

#### 2.1.1 单元测试（Unit）



* 前端：Vitest + React Testing Library

* 后端：pytest

* Agent：对每个 Node 做 “输入→输出” 快照测试（不连真实 DB）

#### 2.1.2 集成测试（Integration）



* 后端：pytest + httpx（启动测试服务器）

* DB：Docker Compose 启动测试库，跑 Alembic 迁移

* SQL 工具：使用固定数据集验证 SQL 安全与正确性

#### 2.1.3 端到端测试（E2E）



* Playwright：覆盖 “问数→澄清→图表→导出→审计可查” 的主链路

#### 2.1.4 评测与回归（LLM/Agent Eval）



* eval 数据集结构（建议）：


  * `single_dim/`、`multi_dim/`、`need_clarify/`、`template/` 四类，每类 ≥100

  * 每条包含：`query`、`expected_clarify`、`expected_sql_shape`（或 AST 规则）、`expected_metrics`、`tolerance`、`must_cite_kb`（是否必须引用口径）

### 2.2 必须验收的指标



* SQL 执行成功率 ≥ 95%

* 结果准确率 > 95%，数值误差 ≤ ±1%

* 澄清缺失项识别准确率 ≥ 98%

* 性能：单维≤3s，多维≤5s，报告≤10s



***

## 3. UI 设计规范

### 3.1 核心设计定位

以 “专业高效、清晰易用、数据驱动” 为核心，适配企业级智能数据分析产品（ChatBI），兼顾业务用户操作便捷性与技术用户功能深度需求，风格统一、视觉层级分明，突出数据可视化直观性。

### 3.2 UI 风格规范

#### 3.2.1 整体风格



* 极简商务风，以数据展示为核心，界面干净专业

#### 3.2.2 色彩体系



* 主色调：#165DFF（专业可靠，用于主按钮、核心标题、重点数据）

* 辅助色：#E8F3FF（信息）、#E6F7EF（成功）、#FFF3E8（警告）

* 中性色：#FFFFFF（背景）、#F5F7FA（浅背景）、#C9CDD4（边框）、#4E5969（正文）、#1D2129（标题）

* 禁用色：#F5F7FA（背景）+ #C9CDD4（文字）

#### 3.2.3 字体规范



* 主字体：思源黑体（中文）、Roboto（英文 / 数字）

* 字体层级：页面标题 18-20px（600 字重）、模块标题 16px（500 字重）、正文 14px（400 字重）、辅助文本 12px（400 字重）、数据数值 14-16px（500 字重，核心数据用主色调）

### 3.3 布局结构规范

#### 3.3.1 整体布局



* 顶部导航栏 + 左侧功能菜单 + 中间主内容区 + 右侧辅助面板（可选），支持响应式


  * 顶部导航栏（60px 高）：含 Logo、用户信息、全局搜索、通知、帮助

  * 左侧功能菜单（220px 展开 / 80px 折叠）：核心功能入口（数据查询、模板中心等），图标 + 文字（折叠仅图标）

  * 中间主内容区：自适应宽度，留白 24px，分查询交互区、数据展示区、报告生成区

  * 右侧辅助面板（300px 展开 / 收起）：用于对话澄清、逻辑说明、参数配置

#### 3.3.2 场景化布局



* 数据洞察归因：上半区（输入框 80%+ 查询按钮 20%），下半区（结论展示 40%+ 图表 60%）

* 数据总结：上半区（模板选择 30%+ 参数输入 50%+ 生成按钮 20%），下半区（报告预览区，支持分章节 + 下载 / 编辑）

### 3.4 核心组件规范

#### 3.4.1 输入类



* 自然语言输入框：48px 高，圆角 8px，默认边框 #C9CDD4，聚焦 #165DFF + 阴影，支持多行（最多 3 行），含清空 / 语音图标

* 参数输入框：40px 高，圆角 6px，默认边框 #C9CDD4，聚焦 #165DFF，下拉选项超 10 条支持搜索

#### 3.4.2 按钮类



* 主按钮：44px 高，圆角 8px，#165DFF 背景，白色文字，hover#0E42D2，点击 #0A36A8

* 次要按钮：44px 高，圆角 8px，白色背景 +#165DFF 边框 / 文字，hover#E8F3FF

* 图标按钮：40px×40px 圆形，透明背景，hover#F5F7FA，图标默认 #4E5969，点击 #165DFF

#### 3.4.3 图表类



* 容器：圆角 12px，阴影（8px 模糊 + 10% 透明度），白色背景，右上角悬浮切换 / 下载 / 放大按钮

* 样式：坐标轴 / 图例 12px，数据标签 11px，多维度用不同辅助色，悬浮 tooltip（白色背景 + 圆角 6px + 阴影，文字 12px）

#### 3.4.4 提示 / 说明类



* 对话澄清气泡：#F5F7FA 背景，圆角 12px，内边距 16px，系统文字 #4E5969，用户文字 #165DFF

* 逻辑说明面板：白色背景 + 1px #E8F7FF 边框，圆角 12px，分区展示（图标 + 标题 + 内容），技术细节默认折叠

#### 3.4.5 报告预览类



* 容器：白色背景，圆角 12px，阴影（8px 模糊 + 10% 透明度），内边距 24px

* 章节：标题 16px（500 字重）+#F5F7FA 分割线，章节间距 16px，数据与图表间距 20px
